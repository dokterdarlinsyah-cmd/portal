import React, { useState, useEffect, useRef } from 'react';
import { 
  Folder, FileCode, Trash2, Save, Plus, ArrowLeft, 
  Github, Loader2, FolderPlus, FilePlus, RefreshCw,
  LogOut, Home, CheckSquare, Square, X, AlertTriangle, CheckCircle, AlertCircle, Download,
  Edit2, Check, MessageCircle, Terminal, Shield
} from 'lucide-react';

// --- Utility Functions for Base64 (Unicode & Binary Support) ---
const utf8_to_b64 = (str) => {
  return window.btoa(unescape(encodeURIComponent(str)));
};

const b64_to_utf8 = (str) => {
  return decodeURIComponent(escape(window.atob(str)));
};

// Helper untuk download binary (gambar, pdf, dll)
const b64_to_blob = (b64Data, contentType = 'application/octet-stream') => {
  const byteCharacters = atob(b64Data);
  const byteArrays = [];
  
  for (let offset = 0; offset < byteCharacters.length; offset += 512) {
    const slice = byteCharacters.slice(offset, offset + 512);
    const byteNumbers = new Array(slice.length);
    for (let i = 0; i < slice.length; i++) {
      byteNumbers[i] = slice.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    byteArrays.push(byteArray);
  }
  
  return new Blob(byteArrays, { type: contentType });
};

// Helper untuk parsing versi (misal: file_v1.2.json -> 1.2)
const parseVersion = (filename) => {
  // Regex mencari pola _vX.X atau .vX.X di akhir nama sebelum ekstensi
  // Mendukung format: nama_v1.json, nama.v1.2.txt, nama-v10.js
  const regex = /[-_.]v?(\d+(?:\.\d+)*)\./i;
  const match = filename.match(regex);
  if (match && match[1]) {
    // Ubah "1.13" menjadi array [1, 13] untuk perbandingan yang benar
    return match[1].split('.').map(Number);
  }
  return null;
};

// Helper untuk membandingkan versi
const compareVersions = (v1, v2) => {
  if (!v1) return -1;
  if (!v2) return 1;
  for (let i = 0; i < Math.max(v1.length, v2.length); i++) {
    const num1 = v1[i] || 0;
    const num2 = v2[i] || 0;
    if (num1 > num2) return 1;
    if (num1 < num2) return -1;
  }
  return 0;
};

export default function App() {
  // --- State ---
  const [auth, setAuth] = useState({
    token: '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',
    owner: 'dokterdarlinsyah-cmd',
    repo: 'Portal',
    branch: 'main',
    isLoggedIn: false
  });

  const [currentPath, setCurrentPath] = useState('');
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [view, setView] = useState('list'); // 'list', 'edit', 'create-file', 'create-folder', 'telegram'
  
  // File Editing State
  const [selectedFile, setSelectedFile] = useState(null);
  const [fileContent, setFileContent] = useState('');
  const [commitMessage, setCommitMessage] = useState('');
  
  // New Item State
  const [newItemName, setNewItemName] = useState('');

  // Bulk Selection State
  const [selectedPaths, setSelectedPaths] = useState(new Set());

  // Inline Rename State
  const [editingItem, setEditingItem] = useState(null);

  // UI State (Modal & Toast)
  const [confirmModal, setConfirmModal] = useState(null);
  const [toast, setToast] = useState(null);

  // Telegram Bot State
  const [telegram, setTelegram] = useState({
    token: '6114981652:AAHprVOPgLRgflcMAS1ou9Bwdg_-EJLGsMk',
    active: true, // Langsung aktif
    offset: 0,
    logs: [],
    protectedFiles: 'code.txt, portal_v1.0.json' // Default protected files
  });
  
  // Gunakan ref untuk akses state terbaru di dalam interval
  const telegramRef = useRef(telegram);
  const authRef = useRef(auth);
  
  useEffect(() => {
    telegramRef.current = telegram;
    authRef.current = auth;
  }, [telegram, auth]);

  // --- API Helpers ---
  const getHeaders = (token) => ({
    'Authorization': `token ${token || auth.token}`,
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json',
  });

  const handleError = (err) => {
    console.error(err);
    const msg = err.message === 'Failed to fetch' 
      ? "Gagal terhubung. Periksa koneksi internet atau Token." 
      : (err.message || "Terjadi kesalahan.");
    
    showToast(msg, 'error');
    setLoading(false);
  };

  const showToast = (message, type = 'success') => {
    setToast({ message, type });
    setTimeout(() => setToast(null), 4000);
  };

  const addLog = (msg) => {
    const timestamp = new Date().toLocaleTimeString();
    setTelegram(prev => ({
      ...prev,
      logs: [`[${timestamp}] ${msg}`, ...prev.logs].slice(0, 50)
    }));
  };

  // --- Telegram Polling Logic ---
  useEffect(() => {
    let intervalId;
    
    const poll = async () => {
      const { token, active, offset } = telegramRef.current;
      if (!active || !token) return;

      try {
        const res = await fetch(`https://api.telegram.org/bot${token}/getUpdates?offset=${offset}&timeout=10`);
        if (!res.ok) return; // Silent fail for polling
        
        const data = await res.json();
        if (data.ok && data.result.length > 0) {
          // Update offset agar pesan tidak dibaca ulang
          const lastUpdate = data.result[data.result.length - 1];
          setTelegram(prev => ({ ...prev, offset: lastUpdate.update_id + 1 }));

          // Process messages
          for (const update of data.result) {
            if (update.message && update.message.text) {
              const text = update.message.text.trim().toLowerCase();
              const chatId = update.message.chat.id;
              
              if (text === 'hapus' || text === '/hapus') {
                addLog(`Menerima perintah 'hapus' dari ${update.message.from.first_name}`);
                await sendTelegramMessage(chatId, "â³ Memproses pembersihan repository...");
                await executeSmartCleanup(chatId);
              }
            }
          }
        }
      } catch (err) {
        console.error("Telegram polling error:", err);
      }
    };

    if (telegram.active) {
      intervalId = setInterval(poll, 3000);
      addLog("Bot Service Started.");
    }

    return () => {
      if (intervalId) clearInterval(intervalId);
    };
  }, [telegram.active]);

  const sendTelegramMessage = async (chatId, text) => {
    const { token } = telegramRef.current;
    try {
      await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: chatId, text: text })
      });
    } catch (e) {
      console.error("Failed to send TG message", e);
    }
  };

  // --- SMART CLEANUP LOGIC ---
  const executeSmartCleanup = async (chatId) => {
    try {
      const { owner, repo, branch, token } = authRef.current;
      const { protectedFiles } = telegramRef.current;
      
      // 1. Parse Protected Files from User Input
      const protectedList = protectedFiles.split(',').map(f => f.trim()).filter(Boolean);
      const fixedTargetName = 'portal_v1.1.json';

      // 2. Fetch current files
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/?ref=${branch}&t=${Date.now()}`;
      const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
      if (!res.ok) throw new Error("Gagal membaca repository.");
      
      const files = await res.json();
      if (!Array.isArray(files)) throw new Error("Struktur repository tidak valid.");

      // 3. Identify Files
      let filesToDelete = [];
      let renameCandidate = null;

      // Filter files (exclude folders)
      const flatFiles = files.filter(f => f.type !== 'dir');
      
      // Cari file dengan versi tertinggi (SELAIN yang dilindungi)
      let maxVersion = null;
      let maxVersionFile = null;

      flatFiles.forEach(file => {
        // Jika file ada di daftar yang dilindungi, abaikan (jangan dijadikan kandidat rename)
        if (protectedList.includes(file.name)) return; 

        const v = parseVersion(file.name);
        if (v) {
          if (compareVersions(v, maxVersion) > 0) {
            maxVersion = v;
            maxVersionFile = file;
          }
        }
      });

      // Tentukan nasib file
      if (maxVersionFile) {
        renameCandidate = maxVersionFile;
        addLog(`Versi terbaru (selain yang dilindungi): ${maxVersionFile.name} -> target: ${fixedTargetName}`);
      } else {
        addLog("Tidak ditemukan file versi baru untuk di-update.");
      }

      // Kumpulkan file yang akan dihapus
      flatFiles.forEach(file => {
        // 1. Jangan hapus jika ada di protectedList
        if (protectedList.includes(file.name)) return; 
        
        // 2. Jangan hapus jika ini adalah source file yang akan di-rename (nanti dihapus khusus setelah rename sukses)
        if (renameCandidate && file.sha === renameCandidate.sha) return; 
        
        // 3. Sisanya hapus
        filesToDelete.push(file);
      });

      // 4. EKSEKUSI DELETE
      if (filesToDelete.length > 0) {
        await sendTelegramMessage(chatId, `ðŸ—‘ Menghapus ${filesToDelete.length} file sampah...`);
        for (const file of filesToDelete) {
           await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
              method: 'DELETE',
              headers: { 
                  'Authorization': `token ${token}`,
                  'Content-Type': 'application/json' 
              },
              body: JSON.stringify({
                  message: `Auto-cleanup: Delete ${file.name}`,
                  sha: file.sha,
                  branch: branch
              })
           });
        }
      }

      // 5. EKSEKUSI RENAME (Create New + Delete Old)
      
      if (renameCandidate) {
        // Ambil konten file terbaru
        const contentRes = await fetch(renameCandidate.url, { headers: { 'Authorization': `token ${token}` } });
        const contentData = await contentRes.json();
        
        // Buat file baru dengan nama portal_v1.1.json
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fixedTargetName}`, {
            method: 'PUT',
            headers: { 
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Auto-rename: ${renameCandidate.name} -> ${fixedTargetName}`,
                content: contentData.content.replace(/\n/g, ''), 
                branch: branch
            })
        });

        // Hapus file versi lama (yang tadi kita copy)
        await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${renameCandidate.path}`, {
            method: 'DELETE',
            headers: { 
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({
                message: `Auto-cleanup: remove source version ${renameCandidate.name}`,
                sha: renameCandidate.sha,
                branch: branch
            })
        });
        
        await sendTelegramMessage(chatId, `âœ… Update sukses: ${renameCandidate.name} menjadi ${fixedTargetName}`);
      }

      await sendTelegramMessage(chatId, "ðŸŽ‰ Proses pembersihan selesai!");
      addLog("Cleanup selesai.");
      fetchPath(''); // Refresh UI jika user sedang melihat

    } catch (err) {
      console.error(err);
      addLog(`Error: ${err.message}`);
      await sendTelegramMessage(chatId, `âŒ Error: ${err.message}`);
    }
  };


  // --- Actions (Standard) ---

  const checkRepo = async () => {
    setLoading(true);
    setError(null);

    const cleanAuth = {
      token: auth.token.trim(),
      owner: auth.owner.trim(),
      repo: auth.repo.trim(),
      branch: auth.branch.trim() || 'main',
      isLoggedIn: true
    };

    if (!cleanAuth.token || !cleanAuth.owner || !cleanAuth.repo) {
      showToast("Mohon isi semua data login.", 'error');
      setLoading(false);
      return;
    }

    try {
      const res = await fetch(`https://api.github.com/repos/${cleanAuth.owner}/${cleanAuth.repo}`, {
        headers: getHeaders(cleanAuth.token)
      });
      
      if (!res.ok) throw new Error("Repository tidak ditemukan atau Token salah.");
      
      setAuth(cleanAuth);
      await fetchPath('', cleanAuth);
    } catch (err) {
      handleError(err);
    }
  };

  const fetchPath = async (path, credsOverride = null) => {
    setLoading(true);
    setError(null);
    setSelectedPaths(new Set()); 
    setEditingItem(null); 
    
    const currentAuth = credsOverride || auth;

    try {
      const url = `https://api.github.com/repos/${currentAuth.owner}/${currentAuth.repo}/contents/${path}?ref=${currentAuth.branch}&t=${Date.now()}`;
      const res = await fetch(url, { headers: getHeaders(currentAuth.token) });
      
      if (!res.ok) throw new Error("Gagal memuat direktori.");
      
      const data = await res.json();
      const sorted = Array.isArray(data) ? data.sort((a, b) => {
        if (a.type === b.type) return a.name.localeCompare(b.name);
        return a.type === 'dir' ? -1 : 1;
      }) : []; 

      setItems(Array.isArray(data) ? sorted : []);
      setCurrentPath(path);
      // Jangan ganti view jika sedang di telegram
      if (view !== 'telegram') setView('list');
    } catch (err) {
      handleError(err);
    } finally {
      setLoading(false);
    }
  };

  const openFile = async (file) => {
    setLoading(true);
    try {
      const res = await fetch(file.url, { headers: getHeaders() });
      if (!res.ok) throw new Error("Gagal membaca file.");
      
      const data = await res.json();
      const content = b64_to_utf8(data.content);
      
      setSelectedFile({ ...file, sha: data.sha });
      setFileContent(content);
      setNewItemName(file.name); 
      setCommitMessage(`Update ${file.name}`);
      setView('edit');
    } catch (err) {
      handleError(err);
    } finally {
      setLoading(false);
    }
  };

  // --- Inline Rename Logic ---

  const startRenaming = (item) => {
    if (item.type === 'dir') {
      showToast("Rename folder belum didukung.", "error");
      return;
    }
    setEditingItem({
      ...item,
      originalName: item.name
    });
  };

  const submitRename = async () => {
    if (!editingItem || !editingItem.name || editingItem.name === editingItem.originalName) {
      setEditingItem(null);
      return;
    }

    setLoading(true);
    try {
      const res = await fetch(editingItem.url, { headers: getHeaders() });
      if (!res.ok) throw new Error("Gagal info file.");
      const data = await res.json();
      
      const cleanContent = data.content ? data.content.replace(/\n/g, '') : '';
      const newPath = currentPath ? `${currentPath}/${editingItem.name}` : editingItem.name;
      
      await fetch(`https://api.github.com/repos/${auth.owner}/${auth.repo}/contents/${newPath}`, {
         method: 'PUT',
         headers: getHeaders(),
         body: JSON.stringify({
            message: `Rename ${editingItem.originalName} to ${editingItem.name}`,
            content: cleanContent, 
            branch: auth.branch
         })
      });
      
      await fetch(`https://api.github.com/repos/${auth.owner}/${auth.repo}/contents/${editingItem.path}`, {
         method: 'DELETE',
         headers: getHeaders(),
         body: JSON.stringify({
             message: `Delete old ${editingItem.originalName}`,
             sha: editingItem.sha,
             branch: auth.branch
         })
      });

      showToast(`Berhasil mengubah nama menjadi ${editingItem.name}`);
      setEditingItem(null);
      fetchPath(currentPath);
    } catch (err) {
      handleError(err);
    } finally {
      setLoading(false);
    }
  };

  // --- Download Logic ---

  const downloadCurrentFile = () => {
    try {
      const blob = new Blob([fileContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = newItemName || selectedFile?.name || 'download.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("File berhasil didownload!");
    } catch (err) {
      console.error(err);
      showToast("Gagal mendownload file.", 'error');
    }
  };

  const downloadSelectedItems = async () => {
    if (selectedPaths.size === 0) {
      showToast("Pilih file yang ingin didownload terlebih dahulu.", 'error');
      return;
    }
    setLoading(true);
    let downloadedCount = 0;
    for (const path of selectedPaths) {
      const item = items.find(i => i.path === path);
      if (!item || item.type === 'dir') continue;

      try {
        const res = await fetch(item.url, { headers: getHeaders() });
        const json = await res.json();
        const blob = b64_to_blob(json.content); 
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = item.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        downloadedCount++;
        await new Promise(r => setTimeout(r, 500));
      } catch (e) {
        console.error(e);
      }
    }
    setLoading(false);
    if (downloadedCount > 0) showToast(`${downloadedCount} file berhasil didownload.`);
  };


  // --- Delete Logic ---

  const initiateDeleteFile = (file) => {
    setConfirmModal({
      title: 'Hapus File?',
      message: `Apakah Anda yakin ingin menghapus "${file.name}"?`,
      onConfirm: () => performDeleteFile(file)
    });
  };

  const performDeleteFile = async (file) => {
    setConfirmModal(null);
    setLoading(true);
    try {
      const res = await fetch(`https://api.github.com/repos/${auth.owner}/${auth.repo}/contents/${file.path}`, {
        method: 'DELETE',
        headers: getHeaders(),
        body: JSON.stringify({
            message: `Delete ${file.name}`,
            sha: file.sha,
            branch: auth.branch
        })
      });
      if (!res.ok) throw new Error("Gagal menghapus file.");
      showToast(`File "${file.name}" berhasil dihapus.`);
      fetchPath(currentPath);
    } catch (err) {
      handleError(err);
    }
  };

  const initiateDeleteBulk = () => {
    setConfirmModal({
      title: `Hapus ${selectedPaths.size} Item?`,
      message: `Tindakan ini permanen. Yakin?`,
      onConfirm: () => performDeleteBulk()
    });
  };

  const performDeleteBulk = async () => {
    setConfirmModal(null);
    setLoading(true);
    let successCount = 0;
    
    const pathsToDelete = Array.from(selectedPaths);
    for (const path of pathsToDelete) {
      const item = items.find(i => i.path === path);
      if (!item) continue;
      try {
        await fetch(`https://api.github.com/repos/${auth.owner}/${auth.repo}/contents/${item.path}`, {
          method: 'DELETE',
          headers: getHeaders(),
          body: JSON.stringify({
              message: `Bulk delete ${item.name}`,
              sha: item.sha,
              branch: auth.branch
          })
        });
        successCount++;
      } catch (e) {
        console.error(e);
      }
    }
    setLoading(false);
    if (successCount > 0) {
      showToast(`${successCount} item dihapus.`);
      fetchPath(currentPath);
    }
  };

  // --- Save & Create Logic ---

  const saveFile = async () => {
    if (!commitMessage || !newItemName) {
      showToast("Nama file dan pesan commit wajib diisi.", 'error');
      return;
    }

    setLoading(true);
    try {
      const contentEncoded = utf8_to_b64(fileContent);
      const isRenaming = newItemName !== selectedFile.name;
      const newPath = `${currentPath ? currentPath + '/' : ''}${newItemName}`;

      if (isRenaming) {
        await fetch(`https://api.github.com/repos/${auth.owner}/${auth.repo}/contents/${newPath}`, {
          method: 'PUT',
          headers: getHeaders(),
          body: JSON.stringify({
              message: commitMessage,
              content: contentEncoded,
              branch: auth.branch
          })
        });

        await fetch(`https://api.github.com/repos/${auth.owner}/${auth.repo}/contents/${selectedFile.path}`, {
          method: 'DELETE',
          headers: getHeaders(),
          body: JSON.stringify({
              message: `Delete old ${selectedFile.name}`,
              sha: selectedFile.sha,
              branch: auth.branch
          })
        });
      } else {
        await fetch(`https://api.github.com/repos/${auth.owner}/${auth.repo}/contents/${selectedFile.path}`, {
          method: 'PUT',
          headers: getHeaders(),
          body: JSON.stringify({
              message: commitMessage,
              content: contentEncoded,
              branch: auth.branch,
              sha: selectedFile.sha
          })
        });
      }

      showToast("Berhasil disimpan!");
      fetchPath(currentPath); 
    } catch (err) {
      handleError(err);
    }
  };

  const createNewItem = async (type) => {
    if (!newItemName || !commitMessage) {
      showToast("Data wajib diisi.", 'error');
      return;
    }

    setLoading(true);
    try {
      const filePath = type === 'folder' 
        ? `${currentPath ? currentPath + '/' : ''}${newItemName}/.gitkeep`
        : `${currentPath ? currentPath + '/' : ''}${newItemName}`;
      
      const contentEncoded = type === 'folder' ? '' : utf8_to_b64(fileContent);

      await fetch(`https://api.github.com/repos/${auth.owner}/${auth.repo}/contents/${filePath}`, {
        method: 'PUT',
        headers: getHeaders(),
        body: JSON.stringify({
            message: commitMessage,
            content: contentEncoded,
            branch: auth.branch
        })
      });

      showToast("Berhasil dibuat!");
      setNewItemName('');
      setCommitMessage('');
      setFileContent('');
      fetchPath(currentPath);
    } catch (err) {
      handleError(err);
    }
  };

  const toggleSelection = (path) => {
    const newSelection = new Set(selectedPaths);
    if (newSelection.has(path)) newSelection.delete(path);
    else newSelection.add(path);
    setSelectedPaths(newSelection);
  };

  const toggleSelectAll = () => {
    if (selectedPaths.size === items.length) setSelectedPaths(new Set());
    else setSelectedPaths(new Set(items.map(item => item.path)));
  };

  // --- Render Helpers ---

  const renderToast = () => {
    if (!toast) return null;
    return (
      <div className={`fixed top-6 right-6 z-50 p-4 rounded-lg shadow-xl flex items-center animate-in slide-in-from-top-2 border ${
        toast.type === 'error' ? 'bg-white border-red-200 text-red-700' : 'bg-white border-green-200 text-green-700'
      }`}>
        {toast.type === 'error' ? <AlertCircle size={20} className="mr-2" /> : <CheckCircle size={20} className="mr-2" />}
        <span className="font-medium">{toast.message}</span>
      </div>
    );
  };

  const renderConfirmModal = () => {
    if (!confirmModal) return null;
    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-in fade-in duration-200">
        <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 scale-100 animate-in zoom-in-95 duration-200">
          <div className="flex flex-col items-center text-center">
            <div className="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mb-4">
              <AlertTriangle size={24} />
            </div>
            <h3 className="text-xl font-bold text-slate-900 mb-2">{confirmModal.title}</h3>
            <p className="text-slate-500 mb-6 text-sm leading-relaxed">{confirmModal.message}</p>
            <div className="flex w-full space-x-3">
              <button onClick={() => setConfirmModal(null)} className="flex-1 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50">Batal</button>
              <button onClick={confirmModal.onConfirm} className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Ya, Hapus</button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // --- Views ---

  const TelegramView = () => (
    <div className="max-w-4xl mx-auto p-6 bg-white rounded-xl shadow-sm border border-slate-200">
        <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold text-slate-800 flex items-center">
                <MessageCircle className="mr-2 text-blue-500" /> Konfigurasi Bot Telegram
            </h2>
            <button onClick={() => setView('list')} className="text-slate-500 hover:text-slate-800">
                <X size={24} />
            </button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="space-y-4">
                <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800">
                    <p className="font-bold mb-2">Cara Menggunakan:</p>
                    <ol className="list-decimal ml-4 space-y-1">
                        <li>Buat bot di Telegram via <b>@BotFather</b></li>
                        <li>Salin <b>HTTP API Token</b> ke kolom di bawah.</li>
                        <li>Klik <b>"Aktifkan Bot"</b>.</li>
                        <li>Kirim chat <code>hapus</code> ke bot Anda di Telegram.</li>
                    </ol>
                </div>

                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Telegram Bot Token</label>
                    <input 
                        type="text" 
                        value={telegram.token}
                        onChange={(e) => setTelegram({...telegram, token: e.target.value})}
                        placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
                        className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
                    />
                </div>

                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center">
                        <Shield size={14} className="mr-1 text-green-600"/>
                        File/Folder yang Dilindungi (Pisahkan koma)
                    </label>
                    <input 
                        type="text" 
                        value={telegram.protectedFiles}
                        onChange={(e) => setTelegram({...telegram, protectedFiles: e.target.value})}
                        placeholder="code.txt, portal_v1.0.json"
                        className="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
                    />
                    <p className="text-xs text-slate-500 mt-1">File ini TIDAK akan dihapus atau di-rename saat pembersihan.</p>
                </div>

                <button 
                    onClick={() => setTelegram(prev => ({ ...prev, active: !prev.active }))}
                    className={`w-full p-3 rounded font-medium transition flex justify-center items-center ${
                        telegram.active 
                        ? 'bg-red-100 text-red-600 hover:bg-red-200' 
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                    }`}
                >
                    {telegram.active ? 'Matikan Bot' : 'Aktifkan Bot'}
                </button>
                
                {telegram.active && (
                    <div className="flex items-center justify-center text-green-600 text-sm animate-pulse">
                        <div className="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                        Bot sedang mendengarkan...
                    </div>
                )}
            </div>

            <div className="bg-slate-900 rounded-lg p-4 font-mono text-xs text-green-400 overflow-y-auto h-64 flex flex-col">
                <div className="flex items-center text-slate-400 mb-2 pb-2 border-b border-slate-700">
                    <Terminal size={14} className="mr-2" /> Live Log
                </div>
                <div className="space-y-1 flex-1">
                    {telegram.logs.length === 0 && <span className="text-slate-600 italic">Menunggu aktivitas...</span>}
                    {telegram.logs.map((log, i) => (
                        <div key={i}>{log}</div>
                    ))}
                </div>
            </div>
        </div>
    </div>
  );

  // --- Main Render ---

  if (!auth.isLoggedIn) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen bg-slate-100 p-4">
        {renderToast()}
        <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border border-slate-200">
          <div className="flex justify-center mb-6"><Github size={48} className="text-slate-800" /></div>
          <h2 className="text-2xl font-bold text-center mb-6 text-slate-800">GitHub File Manager</h2>
          <div className="space-y-4">
            <input type="password" placeholder="Token" className="w-full p-2 border rounded" value={auth.token} onChange={(e) => setAuth({...auth, token: e.target.value})} />
            <div className="grid grid-cols-2 gap-4">
              <input type="text" placeholder="Owner" className="w-full p-2 border rounded" value={auth.owner} onChange={(e) => setAuth({...auth, owner: e.target.value})} />
              <input type="text" placeholder="Repo" className="w-full p-2 border rounded" value={auth.repo} onChange={(e) => setAuth({...auth, repo: e.target.value})} />
            </div>
            <button onClick={checkRepo} disabled={loading} className="w-full bg-slate-900 text-white p-3 rounded font-medium hover:bg-slate-800 flex justify-center items-center">
              {loading ? <Loader2 className="animate-spin" /> : "Masuk"}
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans">
      {renderToast()}
      {renderConfirmModal()}

      <header className="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
        <div className="flex items-center space-x-2">
          <Github className="text-slate-900" />
          <div className="flex flex-col">
            <span className="font-bold text-lg leading-tight">{auth.repo}</span>
            <span className="text-xs text-slate-500">{auth.owner} â€¢ {auth.branch}</span>
          </div>
        </div>
        <div className="flex items-center space-x-2">
            <button 
                onClick={() => setView('telegram')}
                className={`p-2 rounded-full transition ${telegram.active ? 'bg-green-100 text-green-600' : 'hover:bg-slate-100 text-slate-600'}`}
                title="Telegram Bot"
            >
                <MessageCircle size={20} />
            </button>
          {view === 'list' && (
            <button onClick={() => fetchPath(currentPath)} className="p-2 hover:bg-slate-100 rounded-full text-slate-600" title="Refresh">
              <RefreshCw size={20} className={loading ? "animate-spin" : ""} />
            </button>
          )}
          <button onClick={() => { setAuth({...auth, isLoggedIn: false}); setItems([]); setCurrentPath(''); }} className="p-2 text-red-500 hover:bg-red-50 rounded-full" title="Logout">
            <LogOut size={20} />
          </button>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-6 relative">
        {view === 'telegram' && <TelegramView />}
        
        {view === 'list' && (
          <>
            {selectedPaths.size > 0 && (
              <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl z-40 flex items-center space-x-4 animate-in slide-in-from-bottom-4">
                <span className="font-medium whitespace-nowrap">{selectedPaths.size} terpilih</span>
                <div className="h-4 w-px bg-slate-600"></div>
                <button onClick={initiateDeleteBulk} className="text-red-400 hover:text-red-300 font-bold flex items-center"><Trash2 size={18} className="mr-2" /> Hapus</button>
                <button onClick={() => setSelectedPaths(new Set())} className="p-1 hover:bg-slate-700 rounded-full"><X size={18} /></button>
              </div>
            )}

            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
              <div className="flex items-center text-sm text-slate-600 mb-4 overflow-x-auto whitespace-nowrap pb-2">
                  <button onClick={() => fetchPath('')} className="hover:text-blue-600 flex items-center font-medium"><Home size={16} className="mr-1"/> root</button>
                  {currentPath.split('/').filter(Boolean).map((part, index, arr) => (
                    <React.Fragment key={index}>
                      <span className="mx-2 text-slate-400">/</span>
                      <button onClick={() => fetchPath(arr.slice(0, index + 1).join('/'))} className="hover:text-blue-600 font-medium">{part}</button>
                    </React.Fragment>
                  ))}
              </div>
              <div className="flex space-x-2 shrink-0">
                <button onClick={downloadSelectedItems} className="flex items-center px-4 py-2 bg-slate-100 border border-slate-300 rounded-lg text-slate-700 text-sm font-medium"><Download size={16} className="mr-2" /> Download</button>
                <button onClick={() => { setNewItemName(''); setCommitMessage('Create new folder'); setView('create-folder'); }} className="flex items-center px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium"><FolderPlus size={16} className="mr-2 text-yellow-500" /> Folder</button>
                <button onClick={() => { setNewItemName(''); setFileContent(''); setCommitMessage('Create new file'); setView('create-file'); }} className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium"><FilePlus size={16} className="mr-2" /> File</button>
              </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[300px]">
              {loading && items.length === 0 ? (
                <div className="p-12 text-center text-slate-500 flex flex-col items-center justify-center h-full"><Loader2 className="animate-spin mb-3 text-blue-500" size={32} /><span>Memuat...</span></div>
              ) : items.length === 0 ? (
                <div className="p-12 text-center text-slate-400 flex flex-col items-center justify-center h-full"><Folder size={48} className="mb-4 opacity-20" /><span className="text-lg">Kosong</span></div>
              ) : (
                <div className="divide-y divide-slate-100">
                    <div className="flex items-center p-3 border-b border-slate-100 bg-slate-50/50">
                        <div className="mr-3 cursor-pointer p-1 rounded hover:bg-slate-200" onClick={toggleSelectAll}>
                          {selectedPaths.size === items.length && items.length > 0 ? <CheckSquare className="text-blue-600" size={20} /> : <Square className="text-slate-400" size={20} />}
                        </div>
                        <span className="text-xs font-bold text-slate-500 uppercase">Pilih Semua</span>
                    </div>
                    {items.map((item) => {
                      const isSelected = selectedPaths.has(item.path);
                      const isEditing = editingItem && editingItem.path === item.path;
                      return (
                        <div key={item.sha} className={`flex items-center justify-between p-3 group ${isSelected ? 'bg-blue-50/60' : 'hover:bg-slate-50'}`}>
                          <div className="flex items-center flex-1 min-w-0">
                            <div className="mr-3 cursor-pointer p-1" onClick={(e) => { e.stopPropagation(); toggleSelection(item.path); }}>
                              {isSelected ? <CheckSquare className="text-blue-600" size={20} /> : <Square className="text-slate-300 group-hover:text-slate-400" size={20} />}
                            </div>
                            {isEditing ? (
                                <div className="flex items-center flex-1 space-x-2">
                                     <input type="text" value={editingItem.name} onChange={(e) => setEditingItem({...editingItem, name: e.target.value})} className="flex-1 p-1 border rounded text-sm" autoFocus onClick={(e) => e.stopPropagation()} onKeyDown={(e) => { if(e.key === 'Enter') submitRename(); if(e.key === 'Escape') setEditingItem(null); }} />
                                     <button onClick={(e) => {e.stopPropagation(); submitRename()}} className="text-green-600 bg-green-50 p-1 rounded"><Check size={16}/></button>
                                     <button onClick={(e) => {e.stopPropagation(); setEditingItem(null)}} className="text-red-500 bg-red-50 p-1 rounded"><X size={16}/></button>
                                </div>
                            ) : (
                                <div className="flex items-center flex-1 cursor-pointer min-w-0" onClick={() => item.type === 'dir' ? fetchPath(item.path) : openFile(item)}>
                                  <span className="mr-3">{item.type === 'dir' ? <Folder className="text-blue-400" size={24} /> : <FileCode className="text-slate-400" size={24} />}</span>
                                  <span className={`truncate font-medium ${isSelected ? 'text-blue-800' : 'text-slate-700 group-hover:text-blue-600'}`}>{item.name}</span>
                                </div>
                            )}
                          </div>
                          {!isEditing && (
                            <div className="flex items-center space-x-1">
                                {item.type !== 'dir' && (
                                    <>
                                        <button onClick={(e) => { e.stopPropagation(); startRenaming(item); }} className="p-2 text-slate-300 hover:text-blue-600 opacity-0 group-hover:opacity-100"><Edit2 size={16} /></button>
                                        {!isSelected && <button onClick={(e) => { e.stopPropagation(); initiateDeleteFile(item); }} className="p-2 text-slate-300 hover:text-red-600 opacity-0 group-hover:opacity-100"><Trash2 size={16} /></button>}
                                    </>
                                )}
                            </div>
                          )}
                        </div>
                      );
                    })}
                </div>
              )}
            </div>
          </>
        )}

        {(view === 'edit' || view === 'create-file' || view === 'create-folder') && (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-[80vh]">
            <div className="flex items-center justify-between px-6 py-4 border-b">
              <div className="flex items-center space-x-4">
                <button onClick={() => setView('list')} className="text-slate-500 hover:bg-slate-100 p-2 rounded-full"><ArrowLeft size={24} /></button>
                <div className="flex flex-col">
                    <h3 className="font-bold text-lg">{view === 'edit' ? selectedFile?.name : 'Buat Baru'}</h3>
                    <span className="text-xs text-slate-500 font-mono">{currentPath || 'root'}</span>
                </div>
              </div>
              <div className="flex items-center space-x-2">
                {view === 'edit' && <button onClick={downloadCurrentFile} className="flex items-center px-4 py-2 bg-slate-100 text-slate-700 border rounded-lg hover:bg-slate-200 text-sm font-medium"><Download size={16} className="mr-2" /> DL</button>}
                <button onClick={view === 'edit' ? saveFile : () => createNewItem(view === 'create-folder' ? 'folder' : 'file')} disabled={loading} className="flex items-center px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">{loading ? <Loader2 className="animate-spin" /> : <Save className="mr-2" size={18} />} Simpan</button>
              </div>
            </div>
            {(view !== 'list') && (
              <div className="px-6 py-4 bg-slate-50 border-b">
                <input type="text" value={newItemName} onChange={(e) => setNewItemName(e.target.value)} placeholder="Nama File/Folder" className="w-full p-2 border rounded" />
              </div>
            )}
            {view !== 'create-folder' && (
              <div className="flex-1 relative bg-slate-50">
                <textarea className="w-full h-full p-6 font-mono text-sm bg-slate-900 text-slate-100 outline-none resize-none" value={fileContent} onChange={(e) => setFileContent(e.target.value)} placeholder="Code..." spellCheck={false} />
              </div>
            )}
            <div className="p-4 bg-white border-t">
              <input type="text" value={commitMessage} onChange={(e) => setCommitMessage(e.target.value)} placeholder="Pesan Commit" className="w-full p-2 border rounded text-sm" />
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
